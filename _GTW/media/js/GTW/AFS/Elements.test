/*
Run this like::
    $ /usr/bin/js -s -f GTW/AFS/Elements.test -i

to get an interactive Javascript shell with GTW.js and GTW/AFS/Elements.js
loaded

or run it like this::

    $ /usr/bin/d8 GTW/AFS/Elements.test

Generate test output like this::
  ( cd _GTW/media/js/ ; \
       /usr/bin/js -s -f GTW/AFS/Elements.test > GTW/AFS/Elements.test.output )

*/

"use strict";

// Define aliases to allow direct copy/pasting from Python doctest
var False = false, True = true, None = null;

load ("GTW.js")
load ("GTW/AFS/Elements.js")
load ("GTW/inspect.js")
load ("GTW/jsonify.js")

function show_form (form) {
    function lon (e) {
        return ( " '"
               + ( "label" in e
                 ? e.label
                 : ("name" in e ? e.name : "")
                 )
               + "'"
               );
    }
    function aor (e, k) {
        var aor, key = k + "_id", result = "";
        if (key in e) {
            aor = $GTW.AFS.Elements.id_map [e [key]];
            result = ", " + k + " = `" + aor.type + lon (aor) + "`";
        }
        return result;
    }
    function show_element (e, indent) {
        var indent1 = indent + "  ";
        print
            ( indent
            + e.$id + " : "
            + e.type + lon (e)
            + aor (e, "root")
            + aor (e, "anchor")
            + ( "completer" in e
              ? (", completer = " + e.completer.names )
              : ""
              )
            );
        if (e ["children"]) {
            for (var i = 0, li = e.children.length, child; i < li; i++) {
                child = e.child (i);
                show_element (child, indent1);
            }
        }
    }
    show_element (form, "");
    print ("");
}

// Argument for `$GTW.AFS.Form` copied from _GTW/__test__/AFS_Spec.py::
//    fi.as_json_cargo
var f = new $GTW.AFS.Form (
      { '$id' : 'FB'
      , 'children' :
          [ { '$id' : 'FB-0'
            , 'children' :
                [ { '$id' : 'FB-0:0'
                  , 'children' :
                      [ { '$id' : 'FB-0:0:0'
                        , 'allow_new' : True
                        , 'collapsed' : True
                        , 'kind' : 'primary'
                        , 'label' : 'Class'
                        , 'name' : 'left'
                        , 'readonly' : True
                        , 'required' : True
                        , 'type' : 'Field_Entity'
                        , 'type_name' : 'SRM.Boat_Class'
                        , 'value' :
                            { 'init' :
                                { 'cid' : 1
                                , 'pid' : 1
                                }
                            , 'sid' : 'qhCKKsimOo:3Hla747-HuSlL5hzwvBqKojyvIg'
                            }
                        }
                      , { '$id' : 'FB-0:0:1'
                        , 'completer' :
                            { 'entity_p' : True
                            , 'names' :
                                [ 'sail_number'
                                , 'left'
                                , 'nation'
                                , 'sail_number_x'
                                ]
                            , 'treshold' : 1
                            }
                        , 'kind' : 'primary'
                        , 'label' : 'Sail number'
                        , 'name' : 'sail_number'
                        , 'required' : True
                        , 'type' : 'Field'
                        , 'value' :
                            { 'init' : '1107' }
                        }
                      , { '$id' : 'FB-0:0:2'
                        , 'kind' : 'primary'
                        , 'label' : 'Nation'
                        , 'name' : 'nation'
                        , 'type' : 'Field'
                        , 'value' :
                            { 'init' : 'AUT' }
                        }
                      , { '$id' : 'FB-0:0:3'
                        , 'completer' :
                            { 'entity_p' : True
                            , 'names' :
                                [ 'sail_number_x'
                                , 'left'
                                , 'sail_number'
                                , 'nation'
                                ]
                            , 'treshold' : 1
                            }
                        , 'kind' : 'primary'
                        , 'label' : 'Sail number x'
                        , 'name' : 'sail_number_x'
                        , 'type' : 'Field'
                        , 'value' :
                            {}
                        }
                      ]
                  , 'collapsed' : False
                  , 'name' : 'primary'
                  , 'type' : 'Fieldset'
                  }
                , { '$id' : 'FB-0:1'
                  , 'children' :
                      [ { '$id' : 'FB-0:1:0'
                        , 'kind' : 'optional'
                        , 'label' : 'Name'
                        , 'name' : 'name'
                        , 'type' : 'Field'
                        , 'value' :
                            {}
                        }
                      ]
                  , 'collapsed' : True
                  , 'name' : 'optional'
                  , 'type' : 'Fieldset'
                  }
                , { '$id' : 'FB-0:2'
                  , 'children' :
                      [ { '$id' : 'FB-0:2::0'
                        , 'children' :
                            [ { '$id' : 'FB-0:2::0-0'
                              , 'allow_new' : False
                              , 'collapsed' : True
                              , 'hidden' : True
                              , 'kind' : 'primary'
                              , 'label' : 'Boat'
                              , 'name' : 'left'
                              , 'required' : True
                              , 'type' : 'Field_Role_Hidden'
                              , 'type_name' : 'SRM.Boat'
                              , 'value' :
                                  { 'init' :
                                      { 'cid' : 2
                                      , 'pid' : 2
                                      }
                                  , 'sid' : '73AhMKVvgduSBcdc9J-WeU1hPS8BJa7jWlFOkw'
                                  }
                              }
                            , { '$id' : 'FB-0:2::0-1'
                              , 'children' :
                                  [ { '$id' : 'FB-0:2::0-1:0'
                                    , 'allow_new' : False
                                    , 'collapsed' : True
                                    , 'kind' : 'primary'
                                    , 'label' : 'Regatta'
                                    , 'name' : 'right'
                                    , 'required' : True
                                    , 'type' : 'Field_Entity'
                                    , 'type_name' : 'SRM.Regatta'
                                    , 'value' :
                                        { 'init' :
                                            { 'cid' : 6
                                            , 'pid' : 6
                                            }
                                        , 'sid' : 's:FQz-HZIl9NAA:-YHx4IFRn3WMzvWHFWK:b5Q'
                                        }
                                    }
                                  ]
                              , 'collapsed' : False
                              , 'name' : 'primary'
                              , 'type' : 'Fieldset'
                              }
                            , { '$id' : 'FB-0:2::0-2'
                              , 'children' :
                                  [ { '$id' : 'FB-0:2::0-2:0'
                                    , 'allow_new' : True
                                    , 'children' :
                                        [ { '$id' : 'FB-0:2::0-2:0:0'
                                          , 'allow_new' : False
                                          , 'collapsed' : True
                                          , 'completer' :
                                              { 'entity_p' : True
                                              , 'names' :
                                                  [ 'left'
                                                  , 'nation'
                                                  , 'mna_number'
                                                  , 'club'
                                                  ]
                                              , 'treshold' : 1
                                              }
                                          , 'kind' : 'primary'
                                          , 'label' : 'Person'
                                          , 'name' : 'left'
                                          , 'readonly' : True
                                          , 'required' : True
                                          , 'type' : 'Field_Entity'
                                          , 'type_name' : 'PAP.Person'
                                          , 'value' :
                                              { 'init' :
                                                  { 'cid' : 3
                                                  , 'pid' : 3
                                                  }
                                              , 'sid' : 'Fy2PPgkt0OF-ExUfoga3fcrKvv3qjOABiCN9rQ'
                                              }
                                          }
                                        , { '$id' : 'FB-0:2::0-2:0:1'
                                          , 'kind' : 'primary'
                                          , 'label' : 'Nation'
                                          , 'name' : 'nation'
                                          , 'type' : 'Field'
                                          , 'value' :
                                              { 'init' : 'AUT' }
                                          }
                                        , { '$id' : 'FB-0:2::0-2:0:2'
                                          , 'completer' :
                                              { 'entity_p' : True
                                              , 'names' :
                                                  [ 'mna_number'
                                                  , 'left'
                                                  , 'nation'
                                                  , 'club'
                                                  ]
                                              , 'treshold' : 1
                                              }
                                          , 'kind' : 'primary'
                                          , 'label' : 'Mna number'
                                          , 'name' : 'mna_number'
                                          , 'type' : 'Field'
                                          , 'value' :
                                              { 'init' : '29676' }
                                          }
                                        , { '$id' : 'FB-0:2::0-2:0:3'
                                          , 'allow_new' : True
                                          , 'children' :
                                              [ { '$id' : 'FB-0:2::0-2:0:3:0'
                                                , 'completer' :
                                                    { 'entity_p' : True
                                                    , 'names' :
    [ 'name' ]
                                                    , 'treshold' : 1
                                                    }
                                                , 'kind' : 'primary'
                                                , 'label' : 'Name'
                                                , 'name' : 'name'
                                                , 'required' : True
                                                , 'type' : 'Field'
                                                , 'value' :
                                                    {}
                                                }
                                              ]
                                          , 'collapsed' : False
                                          , 'kind' : 'primary'
                                          , 'label' : 'Club'
                                          , 'name' : 'club'
                                          , 'type' : 'Field_Entity'
                                          , 'type_name' : 'SRM.Club'
                                          , 'value' :
                                              { 'init' :
                                                  {}
                                              , 'sid' : 'vPwcc9Gqe25rUmpJ7cBwLBH9yc6iGCbRVfNrEg'
                                              }
                                          }
                                        ]
                                    , 'collapsed' : True
                                    , 'kind' : 'required'
                                    , 'label' : 'Skipper'
                                    , 'name' : 'skipper'
                                    , 'required' : True
                                    , 'type' : 'Field_Entity'
                                    , 'type_name' : 'SRM.Sailor'
                                    , 'value' :
                                        { 'init' :
                                            { 'cid' : 4
                                            , 'pid' : 4
                                            }
                                        , 'sid' : 'OMXS5mItieYGgFiLVGNgcS:zMWmtL8cV6qw9CA'
                                        }
                                    }
                                  ]
                              , 'collapsed' : False
                              , 'name' : 'required'
                              , 'type' : 'Fieldset'
                              }
                            , { '$id' : 'FB-0:2::0-3'
                              , 'children' :
                                  [ { '$id' : 'FB-0:2::0-3:0'
                                    , 'kind' : 'optional'
                                    , 'label' : 'Place'
                                    , 'name' : 'place'
                                    , 'type' : 'Field'
                                    , 'value' :
                                        {}
                                    }
                                  , { '$id' : 'FB-0:2::0-3:1'
                                    , 'kind' : 'optional'
                                    , 'label' : 'Points'
                                    , 'name' : 'points'
                                    , 'type' : 'Field'
                                    , 'value' :
                                        {}
                                    }
                                  ]
                              , 'collapsed' : True
                              , 'name' : 'optional'
                              , 'type' : 'Fieldset'
                              }
                            ]
                        , 'collapsed' : True
                        , 'name' : 'Boat_in_Regatta'
                        , 'role_name' : 'left'
                        , 'type' : 'Entity_Link'
                        , 'type_name' : 'SRM.Boat_in_Regatta'
                        , 'value' :
                            { 'init' :
                                { 'cid' : 7
                                , 'pid' : 7
                                }
                            , 'sid' : 'QSvku2fc3JI02:LH5rBsLqrXDzWvSbNZ-hXkBQ'
                            }
                        }
                      ]
                  , 'name' : 'Boat_in_Regatta'
                  , 'type' : 'Entity_List'
                  , 'type_name' : 'SRM.Boat_in_Regatta'
                  }
                ]
            , 'name' : 'Boat'
            , 'type' : 'Entity'
            , 'type_name' : 'SRM.Boat'
            , 'value' :
                { 'init' :
                    { 'cid' : 2
                    , 'pid' : 2
                    }
                , 'sid' : 'ZE5i0RV4B6i6wEn0wszdszAuXDu121dutn0uEg'
                }
            }
          ]
      , 'type' : 'Form'
      , 'value' :
          { 'sid' : 0 }
      }
);

show_form (f);

var e = $GTW.AFS.Elements.id_map ["FB-0"];
var l = $GTW.AFS.Elements.id_map ["FB-0:2::0"];
print ("FB-0 value :\n"      + $GTW.inspect.show (e.value, undefined, 1));
print ("FB-0:2::0 value :\n" + $GTW.inspect.show (l.value, undefined, 1));
print ("Form values :\n"     + $GTW.inspect.show (f.packed_values (), undefined, 1));

print ("$GTW :\n" + $GTW.inspect.show ($GTW, undefined, 1));

print ("FB-0:2::0 value jsonified :\n  " + $GTW.jsonify (l.value));
print ("Form values jsonified :\n  " + $GTW.jsonify (f.packed_values ()));

// __END__ Elements.test
